<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

/* -------------------------------------------
 App State and Core Functions
------------------------------------------- */
const DEFAULT_API_KEY = 'AIzaSyBY-NvwyiSIJaxI0AOkIwTNRQvm4LoA7yY';

const App = {
  pages: ['welcomeScreen', 'homePage','solvePage','historyPage','settingsPage', 'releaseNotesPage'],
  dataKey: 'qsolve_data_v7', // Kept as requested
  userKey: 'qsolve_user_v7', // Kept as requested
  releaseKey: 'qsolve_release_seen_v7',
  history: [],
  settings: { name: 'Student', avatar:'', theme:'default', fontSize:16, apiKey: '', useDefaultKey: true },
};

function saveAll() {
  localStorage.setItem(App.dataKey, JSON.stringify(App.history));
  localStorage.setItem(App.userKey, JSON.stringify(App.settings));
}

function loadAll() {
  const h = localStorage.getItem(App.dataKey);
  const u = localStorage.getItem(App.userKey);
  App.history = h ? JSON.parse(h) : [];
  App.settings = u ? Object.assign(App.settings, JSON.parse(u)) : App.settings;
  applyTheme();
}

function showPage(id) {
  App.pages.forEach(p => {
    const el = document.getElementById(p);
    if(el) el.style.display='none';
  });
  const page = document.getElementById(id);
  if(!page) return;
  
  const template = document.getElementById(id + "Template");
  if (template) {
    page.innerHTML = template.innerHTML;
  }
  page.style.display='block';

  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.querySelector(`.nav-btn[data-page="${id}"]`);
  if (activeBtn) activeBtn.classList.add('active');
  
  // MODIFIED: Logic to hide banner and header
  const header = document.querySelector('header');
  const banner = document.getElementById('globalWarningBanner');
  const shouldHideChrome = (id === 'welcomeScreen' || id === 'releaseNotesPage');
  
  header.style.display = shouldHideChrome ? 'none' : 'flex';
  if (banner) banner.style.display = shouldHideChrome ? 'none' : 'block';

  // NEW: Toggle body padding class
  if (shouldHideChrome) {
    document.body.classList.add('no-banner');
  } else {
    document.body.classList.remove('no-banner');
  }

  if (id !== 'welcomeScreen' && id !== 'releaseNotesPage') updateHeaderUI();
  if (id === 'settingsPage') updateSettingsPageUI();
  if (id === 'historyPage') refreshHistoryList();
  if (id === 'homePage') refreshHomePage();
}

function applyTheme() {
  document.documentElement.style.fontSize = App.settings.fontSize + 'px';
  document.body.classList.toggle('dark', App.settings.theme === 'dark');
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'show';
    if (type === 'error') toast.classList.add('error');
    setTimeout(() => toast.className = toast.className.replace('show', ''), 3000);
}

function escapeHtml(s) {
  if(!s) return '';
  const el = document.createElement('div');
  el.innerText = s;
  return el.innerHTML;
}

function formatAIResponse(text) {
    return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
}

/* -------------------------------------------
 AI and OCR Functions
------------------------------------------- */
async function getAIResponse(prompt, history) {
  const apiKey = App.settings.useDefaultKey ? DEFAULT_API_KEY : App.settings.apiKey;

  if (!apiKey) {
    showToast('API Key is not set. Please add one in Settings.', 'error');
    return "Error: API Key is required.";
  }
  try {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    const chat = model.startChat({ history });
    const result = await chat.sendMessage(prompt);
    return (await result.response).text();
  } catch (error) {
    console.error("Gemini API Error:", error);
    showToast(`AI Error: ${error.message}. Check console.`, 'error');
    return `AI Error: Could not get a response. Is your key correct?`;
  }
}

async function runOcr(source) {
  const container = document.getElementById('detectedQuestions');
  if (!container) return;
  container.innerHTML = `<p class="muted">Recognizing text... please wait.</p>`;
  try {
    const { data: { text } } = await Tesseract.recognize(source, 'eng');
    const questionRegex = /(?=\n\s*\d+[.)])/;
    let questions = text.split(questionRegex).map(s => s.trim()).filter(Boolean);

    if (questions.length <= 1 && text.includes('\n\n')) {
        questions = text.split(/\n\s*\n+/).map(s => s.trim()).filter(Boolean);
    }
    renderDetectedQuestions(questions, text);
  } catch (err) {
    container.innerHTML = `<p class="muted" style="color:red">OCR Error: ${err.message}</p>`;
  }
}

/* -------------------------------------------
 UI Rendering and Update Functions
------------------------------------------- */
function updateHeaderUI() {
    document.getElementById('greetingSmall').innerText = App.settings.name ? `Hi, ${App.settings.name}` : 'Welcome';
    
    const headerPfp = document.getElementById('headerPfp');
    const headerLogo = document.getElementById('headerLogo');
    if (App.settings.avatar) {
        headerPfp.src = App.settings.avatar;
        headerPfp.classList.remove('hidden');
        headerLogo.classList.add('hidden');
    } else {
        headerPfp.classList.add('hidden');
        headerLogo.classList.remove('hidden');
        headerLogo.textContent = (App.settings.name || 'Q').charAt(0).toUpperCase();
    }
}

function updateSettingsPageUI() {
    document.getElementById('userName').value = App.settings.name || '';
    document.getElementById('avatarPreview').src = App.settings.avatar || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
IA;
    document.getElementById('themeSelect').value = App.settings.theme;
    document.getElementById('fontSizeRange').value = App.settings.fontSize;
    
    document.getElementById('apiKeyInput').value = App.settings.apiKey || '';
    const useCustom = !App.settings.useDefaultKey;
    document.getElementById('settingsUseDefault').checked = !useCustom;
    document.getElementById('settingsUseCustom').checked = useCustom;
    document.getElementById('settingsCustomApiKeyContainer').style.display = useCustom ? 'block' : 'none';
}

function refreshHomePage() {
    const userNameDisplay = document.getElementById('userNameDisplay');
    if(userNameDisplay) userNameDisplay.textContent = App.settings.name || 'Student';

    const recentList = document.getElementById('recentList');
    if (recentList) {
        recentList.innerHTML = '';
        if (App.history.length === 0) {
            recentList.innerHTML = `<p class="muted">Your saved conversations will appear here.</p>`;
            return;
        }
        App.history.slice(0, 3).forEach(item => {
            const title = escapeHtml(item.title.slice(0, 80));
            recentList.innerHTML += `<div class="question-card">${title}...</div>`;
        });
    }
}

function renderDetectedQuestions(questions, fullText) {
    const container = document.getElementById('detectedQuestions');
    container.innerHTML = '<h3>Detected Questions</h3>';
    if (questions.length === 0 && fullText) {
        questions = [fullText];
  .
    }
    questions.forEach((qText) => {
        const questionHtml = escapeHtml(qText);
        container.innerHTML += `
        <div class="question-card">
            <p class="question-text">${questionHtml}</p>
            <div class="ai-answer-container" style="display: none;"></div>
            <div style="display:flex; gap: 8px; align-items:center; margin-top:10px;">
                <select class="ai-personality-select" style="flex-grow:0; width: auto;">
                    <option value="">Default Answer</option>
                    <option value="\\n\\nPlease explain this simply, like I'm 10 years old.">Explain Simply</option>
                    <option value="\\n\\nPlease summarize the key points in a bulleted list.">Summarize</option>
C;
                    <option value="\\n\\nPlease provide a detailed, step-by-step guide.">Step-by-Step</option>
                </select>
                <button class="btn" data-action="start-conversation">Find Answer</button>
            </div>
            <div class="conversation-controls" style="display:none; margin-top:10px;">
                <textarea class="follow-up-input" rows="2" placeholder="Ask a follow-up question..."></textarea>
                <button class="btn" data-action="ask-follow-up" style="margin-top:5px;">Send</button>
Ind;
            </div>
             <div class="save-controls" style="display:none; margin-top:12px;">
                <input type="text" class="tags-input" placeholder="Add tags, comma separated...">
                <button class="btn small secondary" data-action="save-conversation" style="margin-top:5px;">Save to History</button>
            </div>
        </div>`;
    });
}

function refreshHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    historyList.innerHTML = '';
    const searchTerm = (document.getElementById('historySearch')?.value || '').toLowerCase();
    const showFavorites = document.getElementById('showFavoritesToggle')?.checked;

    const filteredHistory = App.history.filter(item => {
        if (showFavorites && !item.isFavorited) return false;
        
        const conversationText = item.conversation.map(turn => turn.parts[0].text).join(' ').toLowerCase();
        const tagsText = (item.tags || []).join(' ').toLowerCase();
        
        return conversationText.includes(searchTerm) || tagsText.includes(searchTerm);
    });

    if (filteredHistory.length === 0) {
        historyList.innerHTML = `<p class="muted">No conversations found.</p>`;
        return;
    }
    filteredHistory.forEach(item => {
        const tagsHtml = (item.tags || []).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('');
ci;
        const conversationHtml = item.conversation.map(turn => {
            const bubbleClass = turn.role === 'user' ? 'user' : 'model';
            return `<div class="chat-bubble ${bubbleClass}">${formatAIResponse(turn.parts[0].text)}</div>`;
        }).join('');
        
        historyList.innerHTML += `<div class="card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <h4>${escapeHtml(item.title)}</h4>
                <button class="favorite-btn ${item.isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-id="${item.id}">★</button>
            </div>
            <div>${tagsHtml}</div>
            <div class="ai-answer-container" style="display:block; margin-top:12px;">${conversationHtml}</div>
ci;
            <div style="margin-top:10px;">
                <button class="btn small secondary" data-action="copy-conversation" data-id="${item.id}">Copy</button>
            </div>
        </div>`;
    });
    if (window.MathJax) MathJax.typesetPromise && MathJax.typesetPromise();
}

function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        App.settings.avatar = e.target.result;
Ind;
        saveAll();
        updateHeaderUI();
        updateSettingsPageUI();
    };
    reader.readAsDataURL(file);
}

/* -------------------------------------------
 Initialization and Event Handling
------------------------------------------- */
function init() {
  loadAll();
  
  document.body.addEventListener('click', async (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    const action = target.dataset.action;
    const card = target.closest('.card, .question-card');
    
    if (action === 'navigate') showPage(target.dataset.page);
    
    if (action === 'accept-welcome') {
      App.settings.name = document.getElementById('setupName').value.trim() || 'Student';
      const useDefault = document.getElementById('setupUseDefault').checked;
      App.settings.useDefaultKey = useDefault;
      if (!useDefault) {
          App.settings.apiKey = document.getElementById('setupApiKey').value.trim();
      } else {
          App.settings.apiKey = '';
      }
      saveAll();
      localStorage.setItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`, 'true');
Ind;
      showPage('homePage');
    }

    if (action === 'continue-from-release') {
        localStorage.setItem(App.releaseKey, 'true');
        const isFirstTime = localStorage.getItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`) !== 'true';
        showPage(isFirstTime ? 'welcomeScreen' : 'homePage');
    }

    if (action === 'run-ocr') {
        const file = document.getElementById('ocrFile')?.files[0];
        const text = document.getElementById('pasteText')?.value.trim();
        if (file) runOcr(file);
        else if (text) renderDetectedQuestions(text.split(/\n\s*\n+/), text);
        else showToast('Please select a file or paste text.', 'error');
    }
    
    if (action === 'start-conversation' || action === 'ask-follow-up') {
        if (!card) return;
        const answerContainer = card.querySelector('.ai-answer-container');
        const questionTextElem = card.querySelector('.question-text');
        const followUpInput = card.querySelector('.follow-up-input');
        
        let prompt;
        let existingHistory = JSON.parse(card.dataset.conversationHistory || '[]');

Ind;
        if (action === 'start-conversation') {
            const personalitySelect = card.querySelector('.ai-personality-select');
            prompt = questionTextElem.innerText + (personalitySelect.value || '');
            answerContainer.innerHTML = `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;
        } else {
            prompt = followUpInput.value.trim();
            if (!prompt) return;
            answerContainer.innerHTML += `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;
            followUpInput.value = '';
        }
        
        answerContainer.style.display = 'block';
        target.textContent = 'Thinking...';
        target.disabled = true;

        const aiResponse = await getAIResponse(prompt, existingHistory);
        
        existingHistory.push({ role: 'user', parts: [{ text: prompt }] });
        existingHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
        card.dataset.conversationHistory = JSON.stringify(existingHistory);

        answerContainer.innerHTML += `<div class="chat-bubble model">${formatAIResponse(aiResponse)}</div>`;
        if (window.MathJax) MathJax.typesetPromise?.([answerContainer]);

        if (action === 'start-conversation') {
            target.parentElement.style.display = 'none';
            card.querySelector('.conversation-controls').style.display = 'block';
            card.querySelector('.save-controls').style.display = 'block';
        }
        target.textContent = action === 'start-conversation' ? 'Find Answer' : 'Send';
        target.disabled = false;
    }
    
    if (action === 'save-conversation') {
        if (!card) return;
        const history = JSON.parse(card.dataset.conversationHistory || '[]');
        if (history.length === 0) return;

        const tagsInput = card.querySelector('.tags-input');
        const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);

        const historyItem = {
            id: 'q-' + Date.now(),
            title: history[0].parts[0].text.slice(0, 100),
            isFavorited: false,
            tags: tags,
            createdAt: new Date().toISOString(),
C;
            conversation: history
        };

        App.history.unshift(historyItem);
        saveAll();
        
        target.textContent = 'Saved ✓';
        target.disabled = true;
        showToast('Conversation saved to history!');
    }

    if (action === 'toggle-favorite') {
        const itemId = target.dataset.id;
        const item = App.history.find(i => i.id === itemId);
        if (item) {
            item.isFavorited = !item.isFavorited;
            saveAll();
            refreshHistoryList();
        }
    }

    if (action === 'copy-conversation') {
        const itemId = target.dataset.id;
        const item = App.history.find(i => i.id === itemId);
        if (item) {
            const textToCopy = item.conversation.map(turn => `${turn.role.toUpperCase()}: ${turn.parts[0].text}`).join('\n\n');
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Conversation copied!');
  TA;
            }, () => {
                showToast('Failed to copy.', 'error');
            });
        }
    }
    
    if (action === 'save-settings') {
      App.settings.name = document.getElementById('userName').value.trim();
      const useDefault = document.getElementById('settingsUseDefault').checked;
      App.settings.useDefaultKey = useDefault;
       if (!useDefault) {
nbsp;
          App.settings.apiKey = document.getElementById('apiKeyInput').value.trim();
      } else {
          App.settings.apiKey = '';
      }
      saveAll();
      updateHeaderUI();
      showToast("Settings saved!");
    }
    
    if (action === 'reset-app') {
        if (confirm('This will permanently delete all your data. Are you sure?')) {
            localStorage.clear();
            window.location.reload();
        }
    }

    if (action === 'export-data') {
        const data = { settings: App.settings, history: App.history };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qsolve_backup_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Data exported!');
    }

        if (action === 'transfer-data') {
        const data = { settings: App.settings, history: App.history };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qsolve_v2_transfer_data.json`; // Specific name for v2
s;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Transfer file created!');
    }

    if (action === 'share') {
        if (navigator.share) {
            navigator.share({ title: 'Q Solve', text: 'Check out this homework helper!', url: window.location.href });
        } else {
            showToast('Web Share not supported on this browser.');
        }
    }
  });
  
  document.body.addEventListener('change', e => {
    const target = e.target;
nbsp;
    if (target.id === 'avatarUpload') handleAvatarUpload(e);
    if (target.id === 'importDataInput') {
        const file = target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if (data.settings && data.history) {
                    App.settings = data.settings;
IA;
                    App.history = data.history;
                    saveAll();
                    loadAll(); 
                    showPage('settingsPage');
                    showToast('Data imported successfully!');
                } else {
                    showToast('Invalid backup file format.', 'error');
Note;
                }
            } catch (err) {
                showToast('Failed to parse backup file.', 'error');
            }
        };
        reader.readAsText(file);
    }
    if (target.id === 'themeSelect') {
        App.settings.theme = target.value;
        applyTheme();
        saveAll();
    }
    
    if (target.name === 'apiKeyChoiceSetup' || target.name === 'apiKeyChoiceSettings') {
        const isSetup = target.name === 'apiKeyChoiceSetup';
        const containerId = isSetup ? 'setupCustomApiKeyContainer' : 'settingsCustomApiKeyContainer';
        const container = document.getElementById(containerId);
        if (container) {
            container.style.display = target.value === 'custom' ? 'block' : 'none';
nbsp;
        }
    }
  });

  document.body.addEventListener('input', e => {
      if (e.target.id === 'fontSizeRange') {
        App.settings.fontSize = e.target.value;
        document.documentElement.style.fontSize = App.settings.fontSize + 'px';
        saveAll();
      }
      if (e.target.id === 'historySearch' || e.target.id === 'showFavoritesToggle') {
        refreshHistoryList();
      }
  });

  const isFirstTime = localStorage.getItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`) !== 'true';
s;
  const releaseSeen = localStorage.getItem(App.releaseKey) === 'true';

  if (isFirstTime && !releaseSeen) {
      showPage('releaseNotesPage');
  } else if (isFirstTime) {
      showPage('welcomeScreen');
  } else {
      showPage('homePage');
  }
}

init();
</script>

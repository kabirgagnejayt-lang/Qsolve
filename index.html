<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="utf-8" />

<meta name="viewport" content="width=device-width,initial-scale=1" />

<title>Q Solve â€” Homework Helper (Mobile Optimized)</title>



<style>

Â  :root {

Â  Â  --primary: #4f46e5; --bg: #f8fafc; --card: #fff; --text: #111827; --muted: #6b7280;

Â  Â  --accent-grad: linear-gradient(90deg,#7c3aed,#4f46e5); --radius: 12px;

Â  Â  --shadow: 0 6px 20px rgba(15,23,42,0.08); --font-size-base: 16px;

Â  }

Â  body.dark {

Â  Â  --bg: #0f1724; --card: #111827; --text: #e6eef8; --muted: #94a3b8; --primary: #60a5fa;

Â  }

Â  html { font-size: var(--font-size-base); }

Â  body {

Â  Â  margin:0; padding:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;

Â  Â  background: var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;

Â  }

Â  header {

Â  Â  padding:14px 18px; display:flex; gap:12px; align-items:center; justify-content:space-between;

Â  Â  background:var(--card); box-shadow:var(--shadow); position:sticky; top:0; z-index:50;

Â  }

Â  .brand { display:flex; align-items:center; gap:12px; }

Â  .logo {

Â  Â  width:44px; height:44px; border-radius:10px; background:var(--accent-grad); display:flex;

Â  Â  align-items:center; justify-content:center; color:white; font-weight:700; flex-shrink: 0;

Â  }

Â  .title { font-weight:700; font-size:1rem; }

Â  .header-avatar {

Â  Â  width: 44px; height: 44px; border-radius: 10px; object-fit: cover; border: 1px solid rgba(0,0,0,0.05);

Â  Â  flex-shrink: 0;

Â  }

Â  nav { display:flex; gap:8px; align-items:center; }

Â  nav button { background:transparent; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; color:var(--muted); }

Â  nav button.active { background:rgba(79,70,229,0.12); color:var(--primary); }

Â  .container { max-width:1100px; margin:18px auto; padding:0 14px; }

Â  .page { display:none; margin-top:14px; }

Â  .card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:14px; }

Â  .row { display:flex; gap:12px; flex-wrap:wrap; }

Â  .col { flex:1; min-width:260px; }

Â  h1,h2,h3,h4 { margin:8px 0; color:var(--text); }

Â  p { color:var(--muted); line-height:1.45; }

Â  .muted { color:var(--muted); font-size:0.95rem; }

Â  input,textarea,select,button { font-size:0.95rem; }

Â  input,select,textarea { width:100%; box-sizing:border-box; padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); background:transparent; color:var(--text); }

Â  .btn { background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }

Â  .btn.secondary { background:transparent; color:var(--muted); border:1px solid rgba(0,0,0,0.06); }

Â  .avatar-preview { width:72px; height:72px; border-radius:50%; object-fit:cover; border:2px solid rgba(0,0,0,0.06); }

Â  .footer { text-align:center; font-size:0.9rem; color:var(--muted); padding:16px 0; }

Â  .hidden { display:none !important; }

Â  #toast {

Â  Â  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);

Â  Â  background: #333; color:white; padding:10px 20px; border-radius:8px;

Â  Â  z-index: 3000; visibility:hidden; opacity:0; transition: all 0.4s ease;

Â  }

Â  #toast.show { visibility:visible; opacity:1; }

Â  #toast.error { background-color: #d9534f; }

Â  .warning-box {

Â  Â  background-color: rgba(255, 193, 7, 0.1);

Â  Â  border: 1px solid rgba(255, 193, 7, 0.6);

Â  Â  border-radius: 8px; padding: 12px; margin-top: 15px;

Â  }

Â  .warning-box p { margin: 5px 0; }

Â  .question-card { margin-top: 10px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.6); border:1px solid rgba(0,0,0,0.03); }

Â  .ai-answer-container {

Â  Â  margin-top: 12px; padding: 10px; border-radius: 8px;

Â  Â  background-color: rgba(79,70,229,0.05); border-left: 3px solid var(--primary);

Â  }

Â  .chat-bubble { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 90%; word-wrap: break-word; }

Â  .chat-bubble.user { background: #eef2ff; color: #4338ca; margin-left: auto; }

Â  .chat-bubble.model { background: rgba(79,70,229,0.05); }

Â  .tag { background: rgba(0,0,0,0.05); color: var(--muted); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; display: inline-block; margin-right: 5px; }

Â  .favorite-btn { background: transparent; border: none; cursor: pointer; font-size: 1.2rem; padding: 0 5px; opacity: 0.6; }

Â  .favorite-btn.favorited { opacity: 1; color: #facc15; }



Â  /* Media Query for Mobile Optimization */

Â  @media (max-width: 768px) {

Â  Â  header { flex-wrap: wrap; gap: 16px; }

Â  Â  nav { width: 100%; order: 3; overflow-x: auto; padding-bottom: 5px; }

Â  Â  .brand { width: 100%; }

Â  Â  .btn[data-action="share"] { display: none; }

Â  Â  .row { flex-direction: column; gap: 0; }

Â  Â  .container { margin: 12px auto; padding: 0 10px; }

Â  Â  h2 { font-size: 1.5rem; }

Â  Â  .btn, input, select, textarea { padding-top: 12px; padding-bottom: 12px; }

Â  Â  #toast { bottom: 80px; width: 90%; box-sizing: border-box; }

Â  }

</style>



<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>

<body>



<header>

Â  <div class="brand">

Â  Â  <div id="headerLogo" class="logo">QS</div>

Â  Â  <img id="headerPfp" alt="avatar" class="header-avatar hidden">

Â  Â  <div>

Â  Â  Â  <div class="title">Q Solve â€” Homework Helper</div>

Â  Â  Â  <div class="muted" id="greetingSmall">Welcome</div>

Â  Â  </div>

Â  </div>

Â  <nav id="mainNav">

Â  Â  <button class="nav-btn" data-action="navigate" data-page="homePage">Home</button>

Â  Â  <button class="nav-btn" data-action="navigate" data-page="solvePage">Solve</button>

Â  Â  <button class="nav-btn" data-action="navigate" data-page="historyPage">History</button>

Â  Â  <button class="nav-btn" data-action="navigate" data-page="settingsPage">Settings</button>

Â  </nav>

Â  <button class="btn small" data-action="share">Share</button>

</header>



<div class="container">

Â  <div id="welcomeScreen" class="page card"></div>

Â  <div id="homePage" class="page"></div>

Â  <div id="solvePage" class="page"></div>

Â  <div id="historyPage" class="page"></div>

Â  <div id="settingsPage" class="page"></div>

Â  <div class="footer card">Q Solve. Local data stored on this device.</div>

</div>



<div id="toast"></div>



<script type="module">

import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";



/* -------------------------------------------

Â App State and Core Functions

------------------------------------------- */

const DEFAULT_API_KEY = 'AIzaSyDFkqehdCYrwxkwR8TSicSLHZrMnAJ3XXY';



const App = {

Â  pages: ['welcomeScreen', 'homePage','solvePage','historyPage','settingsPage'],

Â  dataKey: 'qsolve_data_v5', // Incremented version to avoid old data format issues

Â  userKey: 'qsolve_user_v5',

Â  history: [],

Â  settings: { name: 'Student', avatar:'', theme:'default', fontSize:16, apiKey: '', useDefaultKey: true },

};



function saveAll() {

Â  localStorage.setItem(App.dataKey, JSON.stringify(App.history));

Â  localStorage.setItem(App.userKey, JSON.stringify(App.settings));

}



function loadAll() {

Â  const h = localStorage.getItem(App.dataKey);

Â  const u = localStorage.getItem(App.userKey);

Â  App.history = h ? JSON.parse(h) : [];

Â  App.settings = u ? Object.assign(App.settings, JSON.parse(u)) : App.settings;

Â  applyTheme();

}



function showPage(id) {

Â  App.pages.forEach(p => {

Â  Â  const el = document.getElementById(p);

Â  Â  if(el) el.style.display='none';

Â  });

Â  const page = document.getElementById(id);

Â  if(!page) return;

Â Â 

Â  const template = document.getElementById(id + "Template");

Â  if (template) {

Â  Â  page.innerHTML = template.innerHTML;

Â  }

Â  page.style.display='block';



Â  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

Â  const activeBtn = document.querySelector(`.nav-btn[data-page="${id}"]`);

Â  if (activeBtn) activeBtn.classList.add('active');



Â  updateHeaderUI();

Â  if (id === 'settingsPage') updateSettingsPageUI();

Â  if (id === 'historyPage') refreshHistoryList();

Â  if (id === 'homePage') refreshHomePage();

}



function applyTheme() {

Â  document.documentElement.style.fontSize = App.settings.fontSize + 'px';

Â  document.body.classList.toggle('dark', App.settings.theme === 'dark');

}



function showToast(message, type = 'info') {

Â  Â  const toast = document.getElementById('toast');

Â  Â  toast.textContent = message;

Â  Â  toast.className = 'show';

Â  Â  if (type === 'error') toast.classList.add('error');

Â  Â  setTimeout(() => toast.className = toast.className.replace('show', ''), 3000);

}



function escapeHtml(s) {

Â  if(!s) return '';

Â  const el = document.createElement('div');

Â  el.innerText = s;

Â  return el.innerHTML;

}



function formatAIResponse(text) {

Â  Â  return escapeHtml(text)

Â  Â  Â  Â  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')

Â  Â  Â  Â  .replace(/\*(.*?)\*/g, '<em>$1</em>')

Â  Â  Â  Â  .replace(/\n/g, '<br>');

}



/* -------------------------------------------

Â AI and OCR Functions

------------------------------------------- */

async function getAIResponse(prompt, history) {

Â  const apiKey = App.settings.useDefaultKey ? DEFAULT_API_KEY : App.settings.apiKey;



Â  if (!apiKey) {

Â  Â  showToast('API Key is not set. Please add one in Settings.', 'error');

Â  Â  return "Error: API Key is required.";

Â  }

Â  try {

Â  Â  const genAI = new GoogleGenerativeAI(apiKey);

Â  Â  const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

Â  Â  const chat = model.startChat({ history });

Â  Â  const result = await chat.sendMessage(prompt);

Â  Â  return (await result.response).text();

Â  } catch (error) {

Â  Â  console.error("Gemini API Error:", error);

Â  Â  showToast(`AI Error: ${error.message}. Check console.`, 'error');

Â  Â  return `AI Error: Could not get a response. Is your key correct?`;

Â  }

}



async function runOcr(source) {

Â  const container = document.getElementById('detectedQuestions');

Â  if (!container) return;

Â  container.innerHTML = `<p class="muted">Recognizing text... please wait.</p>`;

Â  try {

Â  Â  const { data: { text } } = await Tesseract.recognize(source, 'eng');

Â  Â  const questionRegex = /(?=\n\s*\d+[.)])/;

Â  Â  let questions = text.split(questionRegex).map(s => s.trim()).filter(Boolean);



Â  Â  if (questions.length <= 1 && text.includes('\n\n')) {

Â  Â  Â  Â  questions = text.split(/\n\s*\n+/).map(s => s.trim()).filter(Boolean);

Â  Â  }

Â  Â  renderDetectedQuestions(questions, text);

Â  } catch (err) {

Â  Â  container.innerHTML = `<p class="muted" style="color:red">OCR Error: ${err.message}</p>`;

Â  }

}



/* -------------------------------------------

Â UI Rendering and Update Functions

------------------------------------------- */

function updateHeaderUI() {

Â  Â  document.getElementById('greetingSmall').innerText = App.settings.name ? `Hi, ${App.settings.name}` : 'Welcome';

Â  Â Â 

Â  Â  const headerPfp = document.getElementById('headerPfp');

Â  Â  const headerLogo = document.getElementById('headerLogo');

Â  Â  if (App.settings.avatar) {

Â  Â  Â  Â  headerPfp.src = App.settings.avatar;

Â  Â  Â  Â  headerPfp.classList.remove('hidden');

Â  Â  Â  Â  headerLogo.classList.add('hidden');

Â  Â  } else {

Â  Â  Â  Â  headerPfp.classList.add('hidden');

Â  Â  Â  Â  headerLogo.classList.remove('hidden');

Â  Â  }

}



function updateSettingsPageUI() {

Â  Â  document.getElementById('userName').value = App.settings.name || '';

Â  Â  document.getElementById('avatarPreview').src = App.settings.avatar || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';

Â  Â  document.getElementById('themeSelect').value = App.settings.theme;

Â  Â  document.getElementById('fontSizeRange').value = App.settings.fontSize;

Â  Â Â 

Â  Â  document.getElementById('apiKeyInput').value = App.settings.apiKey || '';

Â  Â  const useCustom = !App.settings.useDefaultKey;

Â  Â  document.getElementById('settingsUseDefault').checked = !useCustom;

Â  Â  document.getElementById('settingsUseCustom').checked = useCustom;

Â  Â  document.getElementById('settingsCustomApiKeyContainer').style.display = useCustom ? 'block' : 'none';

}



function refreshHomePage() {

Â  Â  const userNameDisplay = document.getElementById('userNameDisplay');

Â  Â  if(userNameDisplay) userNameDisplay.textContent = App.settings.name || 'Student';



Â  Â  const recentList = document.getElementById('recentList');

Â  Â  if (recentList) {

Â  Â  Â  Â  recentList.innerHTML = '';

Â  Â  Â  Â  if (App.history.length === 0) {

Â  Â  Â  Â  Â  Â  recentList.innerHTML = `<p class="muted">Your saved conversations will appear here.</p>`;

Â  Â  Â  Â  Â  Â  return;

Â  Â  Â  Â  }

Â  Â  Â  Â  App.history.slice(0, 3).forEach(item => {

Â  Â  Â  Â  Â  Â  const title = escapeHtml(item.title.slice(0, 80));

Â  Â  Â  Â  Â  Â  recentList.innerHTML += `<div class="question-card">${title}...</div>`;

Â  Â  Â  Â  });

Â  Â  }

}



function renderDetectedQuestions(questions, fullText) {

Â  Â  const container = document.getElementById('detectedQuestions');

Â  Â  container.innerHTML = '<h3>Detected Questions</h3>';

Â  Â  if (questions.length === 0 && fullText) {

Â  Â  Â  Â  questions = [fullText];

Â  Â  }

Â  Â  questions.forEach((qText) => {

Â  Â  Â  Â  const questionHtml = escapeHtml(qText);

Â  Â  Â  Â  container.innerHTML += `

Â  Â  Â  Â  <div class="question-card">

Â  Â  Â  Â  Â  Â  <p class="question-text">${questionHtml}</p>

Â  Â  Â  Â  Â  Â  <div class="ai-answer-container" style="display: none;"></div>

Â  Â  Â  Â  Â  Â  <div style="display:flex; gap: 8px; align-items:center; margin-top:10px;">

Â  Â  Â  Â  Â  Â  Â  Â  <select class="ai-personality-select" style="flex-grow:0; width: auto;">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">Default Answer</option>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="\\n\\nPlease explain this simply, like I'm 10 years old.">Explain Simply</option>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="\\n\\nPlease summarize the key points in a bulleted list.">Summarize</option>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="\\n\\nPlease provide a detailed, step-by-step guide.">Step-by-Step</option>

Â  Â  Â  Â  Â  Â  Â  Â  </select>

Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" data-action="start-conversation">Find Answer</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="conversation-controls" style="display:none; margin-top:10px;">

Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="follow-up-input" rows="2" placeholder="Ask a follow-up question..."></textarea>

Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" data-action="ask-follow-up" style="margin-top:5px;">Send</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â <div class="save-controls" style="display:none; margin-top:12px;">

Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="tags-input" placeholder="Add tags, comma separated...">

Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn small secondary" data-action="save-conversation" style="margin-top:5px;">Save to History</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>`;

Â  Â  });

}



function refreshHistoryList() {

Â  Â  const historyList = document.getElementById('historyList');

Â  Â  if (!historyList) return;

Â  Â  historyList.innerHTML = '';

Â  Â  const searchTerm = (document.getElementById('historySearch')?.value || '').toLowerCase();

Â  Â  const showFavorites = document.getElementById('showFavoritesToggle')?.checked;



Â  Â  const filteredHistory = App.history.filter(item => {

Â  Â  Â  Â  if (showFavorites && !item.isFavorited) return false;

Â  Â  Â  Â Â 

Â  Â  Â  Â  // FIX: Access the text content correctly from the new data structure

Â  Â  Â  Â  const conversationText = item.conversation.map(turn => turn.parts[0].text).join(' ').toLowerCase();

Â  Â  Â  Â  const tagsText = (item.tags || []).join(' ').toLowerCase();

Â  Â  Â  Â Â 

Â  Â  Â  Â  return conversationText.includes(searchTerm) || tagsText.includes(searchTerm);

Â  Â  });



Â  Â  if (filteredHistory.length === 0) {

Â  Â  Â  Â  historyList.innerHTML = `<p class="muted">No conversations found.</p>`;

Â  Â  Â  Â  return;

Â  Â  }

Â  Â  filteredHistory.forEach(item => {

Â  Â  Â  Â  const tagsHtml = (item.tags || []).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('');

Â  Â  Â  Â  const conversationHtml = item.conversation.map(turn => {

Â  Â  Â  Â  Â  Â  const bubbleClass = turn.role === 'user' ? 'user' : 'model';

Â  Â  Â  Â  Â  Â  // FIX: Access the text content correctly from the new data structure

Â  Â  Â  Â  Â  Â  return `<div class="chat-bubble ${bubbleClass}">${formatAIResponse(turn.parts[0].text)}</div>`;

Â  Â  Â  Â  }).join('');

Â  Â  Â  Â Â 

Â  Â  Â  Â  historyList.innerHTML += `<div class="question-card">

Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:start;">

Â  Â  Â  Â  Â  Â  Â  Â  <h4>${escapeHtml(item.title)}</h4>

Â  Â  Â  Â  Â  Â  Â  Â  <button class="favorite-btn ${item.isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-id="${item.id}">â˜…</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div>${tagsHtml}</div>

Â  Â  Â  Â  Â  Â  <div class="ai-answer-container" style="display:block; margin-top:12px;">${conversationHtml}</div>

Â  Â  Â  Â  Â  Â  <div style="margin-top:10px;">

Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn small secondary" data-action="copy-conversation" data-id="${item.id}">Copy</button>

Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>`;

Â  Â  });

Â  Â  if (window.MathJax) MathJax.typesetPromise && MathJax.typesetPromise();

}



function handleAvatarUpload(event) {

Â  Â  const file = event.target.files[0];

Â  Â  if (!file) return;

Â  Â  const reader = new FileReader();

Â  Â  reader.onload = (e) => {

Â  Â  Â  Â  App.settings.avatar = e.target.result;

Â  Â  Â  Â  saveAll();

Â  Â  Â  Â  updateHeaderUI();

Â  Â  Â  Â  updateSettingsPageUI();

Â  Â  };

Â  Â  reader.readAsDataURL(file);

}



/* -------------------------------------------

Â Initialization and Event Handling

------------------------------------------- */

function init() {

Â  loadAll();

Â Â 

Â  document.body.addEventListener('click', async (e) => {

Â  Â  const target = e.target.closest('[data-action]');

Â  Â  if (!target) return;

Â  Â  const action = target.dataset.action;

Â  Â  const card = target.closest('.question-card');

Â  Â Â 

Â  Â  if (action === 'navigate') showPage(target.dataset.page);

Â  Â Â 

Â  Â  if (action === 'accept-welcome') {

Â  Â  Â  App.settings.name = document.getElementById('setupName').value.trim() || 'Student';

Â  Â  Â  const useDefault = document.getElementById('setupUseDefault').checked;

Â  Â  Â  App.settings.useDefaultKey = useDefault;

Â  Â  Â  if (!useDefault) {

Â  Â  Â  Â  Â  App.settings.apiKey = document.getElementById('setupApiKey').value.trim();

Â  Â  Â  } else {

Â  Â  Â  Â  Â  App.settings.apiKey = '';

Â  Â  Â  }

Â  Â  Â  saveAll();

Â  Â  Â  localStorage.setItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`, 'true');

Â  Â  Â  showPage('homePage');

Â  Â  }



Â  Â  if (action === 'run-ocr') {

Â  Â  Â  Â  const file = document.getElementById('ocrFile')?.files[0];

Â  Â  Â  Â  const text = document.getElementById('pasteText')?.value.trim();

Â  Â  Â  Â  if (file) runOcr(file);

Â  Â  Â  Â  else if (text) renderDetectedQuestions(text.split(/\n\s*\n+/), text);

Â  Â  Â  Â  else showToast('Please select a file or paste text.', 'error');

Â  Â  }

Â  Â Â 

Â  Â  if (action === 'start-conversation' || action === 'ask-follow-up') {

Â  Â  Â  Â  if (!card) return;

Â  Â  Â  Â  const answerContainer = card.querySelector('.ai-answer-container');

Â  Â  Â  Â  const questionTextElem = card.querySelector('.question-text');

Â  Â  Â  Â  const followUpInput = card.querySelector('.follow-up-input');

Â  Â  Â  Â Â 

Â  Â  Â  Â  let prompt;

Â  Â  Â  Â  let existingHistory = JSON.parse(card.dataset.conversationHistory || '[]');



Â  Â  Â  Â  if (action === 'start-conversation') {

Â  Â  Â  Â  Â  Â  const personalitySelect = card.querySelector('.ai-personality-select');

Â  Â  Â  Â  Â  Â  prompt = questionTextElem.innerText + (personalitySelect.value || '');

Â  Â  Â  Â  Â  Â  answerContainer.innerHTML = `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  prompt = followUpInput.value.trim();

Â  Â  Â  Â  Â  Â  if (!prompt) return;

Â  Â  Â  Â  Â  Â  answerContainer.innerHTML += `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;

Â  Â  Â  Â  Â  Â  followUpInput.value = '';

Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  answerContainer.style.display = 'block';

Â  Â  Â  Â  target.textContent = 'Thinking...';

Â  Â  Â  Â  target.disabled = true;



Â  Â  Â  Â  const aiResponse = await getAIResponse(prompt, existingHistory);

Â  Â  Â  Â Â 

Â  Â  Â  Â  // FIX: Use the robust, object-based format for 'parts'

Â  Â  Â  Â  existingHistory.push({ role: 'user', parts: [{ text: prompt }] });

Â  Â  Â  Â  existingHistory.push({ role: 'model', parts: [{ text: aiResponse }] });

Â  Â  Â  Â  card.dataset.conversationHistory = JSON.stringify(existingHistory);



Â  Â  Â  Â  answerContainer.innerHTML += `<div class="chat-bubble model">${formatAIResponse(aiResponse)}</div>`;

Â  Â  Â  Â  if (window.MathJax) MathJax.typesetPromise?.([answerContainer]);



Â  Â  Â  Â  if (action === 'start-conversation') {

Â  Â  Â  Â  Â  Â  target.parentElement.style.display = 'none';

Â  Â  Â  Â  Â  Â  card.querySelector('.conversation-controls').style.display = 'block';

Â  Â  Â  Â  Â  Â  card.querySelector('.save-controls').style.display = 'block';

Â  Â  Â  Â  }

Â  Â  Â  Â  target.textContent = action === 'start-conversation' ? 'Find Answer' : 'Send';

Â  Â  Â  Â  target.disabled = false;

Â  Â  }

Â  Â Â 

Â  Â  if (action === 'save-conversation') {

Â  Â  Â  Â  if (!card) return;

Â  Â  Â  Â  const history = JSON.parse(card.dataset.conversationHistory || '[]');

Â  Â  Â  Â  if (history.length === 0) return;



Â  Â  Â  Â  const tagsInput = card.querySelector('.tags-input');

Â  Â  Â  Â  const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);



Â  Â  Â  Â  const historyItem = {

Â  Â  Â  Â  Â  Â  id: 'q-' + Date.now(),

Â  Â  Â  Â  Â  Â  // FIX: Access the text content correctly for the title

Â  Â  Â  Â  Â  Â  title: history[0].parts[0].text.slice(0, 100),

Â  Â  Â  Â  Â  Â  isFavorited: false,

Â  Â  Â  Â  Â  Â  tags: tags,

Â  Â  Â  Â  Â  Â  createdAt: new Date().toISOString(),

Â  Â  Â  Â  Â  Â  conversation: history

Â  Â  Â  Â  };



Â  Â  Â  Â  App.history.unshift(historyItem);

Â  Â  Â  Â  saveAll();

Â  Â  Â  Â Â 

Â  Â  Â  Â  target.textContent = 'Saved âœ“';

Â  Â  Â  Â  target.disabled = true;

Â  Â  Â  Â  showToast('Conversation saved to history!');

Â  Â  }



Â  Â  if (action === 'toggle-favorite') {

Â  Â  Â  Â  const itemId = target.dataset.id;

Â  Â  Â  Â  const item = App.history.find(i => i.id === itemId);

Â  Â  Â  Â  if (item) {

Â  Â  Â  Â  Â  Â  item.isFavorited = !item.isFavorited;

Â  Â  Â  Â  Â  Â  saveAll();

Â  Â  Â  Â  Â  Â  refreshHistoryList();

Â  Â  Â  Â  }

Â  Â  }



Â  Â  if (action === 'copy-conversation') {

Â  Â  Â  Â  const itemId = target.dataset.id;

Â  Â  Â  Â  const item = App.history.find(i => i.id === itemId);

Â  Â  Â  Â  if (item) {

Â  Â  Â  Â  Â  Â  // FIX: Access the text content correctly and use the correct newline character

Â  Â  Â  Â  Â  Â  const textToCopy = item.conversation.map(turn => `${turn.role.toUpperCase()}: ${turn.parts[0].text}`).join('\n\n');

Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(textToCopy).then(() => {

Â  Â  Â  Â  Â  Â  Â  Â  showToast('Conversation copied!');

Â  Â  Â  Â  Â  Â  }, () => {

Â  Â  Â  Â  Â  Â  Â  Â  showToast('Failed to copy.', 'error');

Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  }

Â  Â  }

Â  Â Â 

Â  Â  if (action === 'save-settings') {

Â  Â  Â  App.settings.name = document.getElementById('userName').value.trim();

Â  Â  Â  const useDefault = document.getElementById('settingsUseDefault').checked;

Â  Â  Â  App.settings.useDefaultKey = useDefault;

Â  Â  Â  Â if (!useDefault) {

Â  Â  Â  Â  Â  App.settings.apiKey = document.getElementById('apiKeyInput').value.trim();

Â  Â  Â  } else {

Â  Â  Â  Â  Â  App.settings.apiKey = '';

Â  Â  Â  }

Â  Â  Â  saveAll();

Â  Â  Â  updateHeaderUI();

Â  Â  Â  showToast("Settings saved!");

Â  Â  }

Â  Â Â 

Â  Â  if (action === 'reset-app') {

Â  Â  Â  Â  if (confirm('This will permanently delete all your data. Are you sure?')) {

Â  Â  Â  Â  Â  Â  localStorage.clear();

Â  Â  Â  Â  Â  Â  App.history = [];

Â  Â  Â  Â  Â  Â  App.settings = { name: 'Student', avatar:'', theme:'default', fontSize:16, apiKey: '', useDefaultKey: true };

Â  Â  Â  Â  Â  Â  applyTheme();

Â  Â  Â  Â  Â  Â  updateHeaderUI();Â 

Â  Â  Â  Â  Â  Â  showPage('welcomeScreen');

Â  Â  Â  Â  Â  Â  showToast('App has been reset.');

Â  Â  Â  Â  }

Â  Â  }



Â  Â  if (action === 'export-data') {

Â  Â  Â  Â  const data = {

Â  Â  Â  Â  Â  Â  settings: App.settings,

Â  Â  Â  Â  Â  Â  history: App.history

Â  Â  Â  Â  };

Â  Â  Â  Â  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });

Â  Â  Â  Â  const url = URL.createObjectURL(blob);

Â  Â  Â  Â  const a = document.createElement('a');

Â  Â  Â  Â  a.href = url;

Â  Â  Â  Â  a.download = `qsolve_backup_${Date.now()}.json`;

Â  Â  Â  Â  a.click();

Â  Â  Â  Â  URL.revokeObjectURL(url);

Â  Â  Â  Â  showToast('Data exported!');

Â  Â  }



Â  Â  if (action === 'share') {

Â  Â  Â  Â  if (navigator.share) {

Â  Â  Â  Â  Â  Â  navigator.share({ title: 'Q Solve', text: 'Check out this homework helper!', url: window.location.href });

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  showToast('Web Share not supported on this browser.');

Â  Â  Â  Â  }

Â  Â  }

Â  });

Â Â 

Â  document.body.addEventListener('change', e => {

Â  Â  const target = e.target;

Â  Â  if (target.id === 'avatarUpload') handleAvatarUpload(e);

Â  Â  if (target.id === 'importDataInput') {

Â  Â  Â  Â  const file = target.files[0];

Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  const reader = new FileReader();

Â  Â  Â  Â  reader.onload = (event) => {

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(event.target.result);

Â  Â  Â  Â  Â  Â  Â  Â  if (data.settings && data.history) {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  App.settings = data.settings;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  App.history = data.history;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveAll();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadAll();Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showPage('settingsPage');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Data imported successfully!');

Â  Â  Â  Â  Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Invalid backup file format.', 'error');

Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (err) {

Â  Â  Â  Â  Â  Â  Â  Â  showToast('Failed to parse backup file.', 'error');

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  };

Â  Â  Â  Â  reader.readAsText(file);

Â  Â  }

Â  Â  if (target.id === 'themeSelect') {

Â  Â  Â  Â  App.settings.theme = target.value;

Â  Â  Â  Â  applyTheme();

Â  Â  Â  Â  saveAll();

Â  Â  }

Â  Â Â 

Â  Â  if (target.name === 'apiKeyChoiceSetup' || target.name === 'apiKeyChoiceSettings') {

Â  Â  Â  Â  const isSetup = target.name === 'apiKeyChoiceSetup';

Â  Â  Â  Â  const containerId = isSetup ? 'setupCustomApiKeyContainer' : 'settingsCustomApiKeyContainer';

Â  Â  Â  Â  const container = document.getElementById(containerId);

Â  Â  Â  Â  if (container) {

Â  Â  Â  Â  Â  Â  container.style.display = target.value === 'custom' ? 'block' : 'none';

Â  Â  Â  Â  }

Â  Â  }

Â  });



Â  document.body.addEventListener('input', e => {

Â  Â  Â  if (e.target.id === 'fontSizeRange') {

Â  Â  Â  Â  App.settings.fontSize = e.target.value;

Â  Â  Â  Â  document.documentElement.style.fontSize = App.settings.fontSize + 'px';

Â  Â  Â  Â  saveAll();

Â  Â  Â  }

Â  Â  Â  if (e.target.id === 'historySearch' || e.target.id === 'showFavoritesToggle') {

Â  Â  Â  Â  refreshHistoryList();

Â  Â  Â  }

Â  });



Â  const firstTime = localStorage.getItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`) !== 'true';

Â  showPage(firstTime ? 'welcomeScreen' : 'homePage');

}



init();

</script>



<template id="welcomeScreenTemplate">

Â  <h2>Welcome to Q Solve</h2>

Â  <p class="muted">Your personal homework helper. To get started, please set your name and choose an API key option.</p>

Â  <div style="margin-top:20px;">

Â  Â  <label>Your Name</label>

Â  Â  <input id="setupName" placeholder="e.g., Alex" />

Â  </div>

Â Â 

Â  <div class="warning-box">

Â  Â  <p><strong>AI Features</strong></p>

Â  Â  <div id="setupApiKeyOptions" style="margin-top:8px;">

Â  Â  Â  Â  <input type="radio" id="setupUseDefault" name="apiKeyChoiceSetup" value="default" checked>

Â  Â  Â  Â  <label for="setupUseDefault" class="muted">Use the default shared API key</label>

Â  Â  Â  Â  <br>

Â  Â  Â  Â  <input type="radio" id="setupUseCustom" name="apiKeyChoiceSetup" value="custom" style="margin-top:5px;">

Â  Â  Â  Â  <label for="setupUseCustom" class="muted">Use my own Gemini API key</label>

Â  Â  </div>

Â  Â  <div id="setupCustomApiKeyContainer" style="display:none; margin-top:10px;">

Â  Â  Â  Â  <p class="muted" style="margin-bottom:5px;">Get a free key from <a href="https://aistudio.google.com/" target="_blank" rel="noopener">aistudio.google.com</a>.</p>

Â  Â  Â  Â  <input type="password" id="setupApiKey" placeholder="Paste your key here">

Â  Â  </div>

Â  </div>



Â  <button class="btn" data-action="accept-welcome" style="margin-top:15px;">Start Solving</button>

</template>



<template id="homePageTemplate">

Â  <div class="card">

Â  Â  <h2>Hello, <span id="userNameDisplay">Student</span> ðŸ‘‹</h2>

Â  Â  <p class="muted">Ready to solve some problems? Get started below.</p>

Â  Â  <div style="display:flex; gap:8px; margin-top:8px;">

Â  Â  Â  <button class="btn" data-action="navigate" data-page="solvePage">Solve a New Question</button>

Â  Â  Â  <button class="btn secondary" data-action="navigate" data-page="historyPage">View History</button>

Â  Â  </div>

Â  </div>

Â  <div class="card">

Â  Â  <h3>Recent Conversations</h3>

Â  Â  <div id="recentList"></div>

Â  </div>

</template>



<template id="solvePageTemplate">

Â  <div class="card">

Â  Â  <h2>Solve a Question</h2>

Â  Â  <p class="muted">Upload an image of a worksheet or paste text directly to begin.</p>

Â  Â  <input type="file" id="ocrFile" accept="image/*,application/pdf">

Â  Â  <textarea id="pasteText" rows="4" placeholder="Or paste question text here..." style="margin-top:8px;"></textarea>

Â  Â  <button class="btn" data-action="run-ocr" style="margin-top:8px;">Extract Questions</button>

Â  Â  <div id="detectedQuestions" style="margin-top:12px;"></div>

Â  </div>

</template>



<template id="historyPageTemplate">

Â  <div class="card">

Â  Â  Â  <h2>Conversation History</h2>

Â  Â  Â  <p class="muted">All your saved conversations and their AI-generated answers.</p>

Â  Â  Â  <input type="search" id="historySearch" placeholder="Search conversations..." style="margin-bottom:10px;">

Â  Â  Â  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">

Â  Â  Â  Â  <input type="checkbox" id="showFavoritesToggle" style="width: auto; margin:0;">

Â  Â  Â  Â  <label for="showFavoritesToggle" class="muted">Show Favorites Only</label>

Â  Â  Â  </div>

Â  Â  Â  <div id="historyList" style="margin-top:12px;"></div>

Â  </div>

</template>



<template id="settingsPageTemplate">

Â  <div class="row">

Â  Â  <div class="col card">

Â  Â  Â  <h2>Profile</h2>

Â  Â  Â  <div style="display:flex; gap:12px; align-items:center;">

Â  Â  Â  Â  <img src="" alt="avatar" id="avatarPreview" class="avatar-preview">

Â  Â  Â  Â  <div style="flex:1;">

Â  Â  Â  Â  Â  <input type="text" id="userName" placeholder="Your name">

Â  Â  Â  Â  Â  <input type="file" id="avatarUpload" accept="image/*" style="margin-top:8px;">

Â  Â  Â  Â  </div>

Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div class="col card">

Â  Â  Â  <h2>AI Settings</h2>

Â  Â  Â  <div id="settingsApiKeyOptions">

Â  Â  Â  Â  Â  <input type="radio" id="settingsUseDefault" name="apiKeyChoiceSettings" value="default">

Â  Â  Â  Â  Â  <label for="settingsUseDefault">Use the default shared API key</label>

Â  Â  Â  Â  Â  <br>

Â  Â  Â  Â  Â  <input type="radio" id="settingsUseCustom" name="apiKeyChoiceSettings" value="custom" style="margin-top:5px;">

Â  Â  Â  Â  Â  <label for="settingsUseCustom">Use my own Gemini API key</label>

Â  Â  Â  </div>

Â  Â  Â  <div id="settingsCustomApiKeyContainer" style="display:none; margin-top:10px;">

Â  Â  Â  Â  Â  <p class="muted" style="margin-bottom:5px;">Get a free key from <a href="https://aistudio.google.com/" target="_blank" rel="noopener">aistudio.google.com</a>.</p>

Â  Â  Â  Â  Â  <input type="password" id="apiKeyInput" placeholder="Paste your key here">

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <div class="row">

Â  Â  <div class="col card">

Â  Â  Â  <h2>Preferences</h2>

Â  Â  Â  <label>Theme</label>

Â  Â  Â  <select id="themeSelect">

Â  Â  Â  Â  <option value="default">Purple (Default)</option>

Â  Â  Â  Â  <option value="dark">Dark</option>

Â  Â  Â  </select>

Â  Â  Â  <label style="margin-top:8px;">Font size</label>

Â  Â  Â  <input id="fontSizeRange" type="range" min="12" max="20" step="1">

Â  Â  </div>

Â  Â  <div class="col card">

Â  Â  Â  <h2>Data Management</h2>

Â  Â  Â  <p class="muted">Backup or restore your data, or reset the app completely.</p>

Â  Â  Â  <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">

Â  Â  Â  Â  <button class="btn small" data-action="export-data">Export Data</button>

Â  Â  Â  Â  <input type="file" id="importDataInput" accept=".json" class="hidden">

Â  Â  Â  Â  <label for="importDataInput" class="btn small secondary">Import Data</label>

Â  Â  Â  Â  <button class="btn small" data-action="reset-app" style="background:#ef4444;">Reset App</button>

Â  Â  Â  </div>

Â  Â  </div>

Â  </div>

Â  <div class="card" style="text-align:center;">

Â  Â  Â  <button class="btn" data-action="save-settings">Save All Settings</button>

Â  </div>

</template>



</body>

</html>

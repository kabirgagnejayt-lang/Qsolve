<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Q Solve â€” Homework Helper (Web)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary-hue: 205;
    --primary-main: hsl(var(--primary-hue), 85%, 45%);
    --primary-light: hsl(var(--primary-hue), 90%, 95%);
    --primary-dark: hsl(var(--primary-hue), 80%, 35%);
    --primary-gradient: linear-gradient(45deg, hsl(var(--primary-hue), 85%, 50%), hsl(220, 85%, 55%));

    --bg: #f8fafc;
    --card: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --border: #e2e8f0;

    --success: #22c55e;
    --danger: #ef4444;
    --warning: #f97316;
    --warning-light: #fffbeb;
    --warning-text: #b45309;

    --radius-sm: 6px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -4px rgba(0,0,0,0.07);
    --transition-speed: 0.2s;
  }

  body.dark {
    --primary-hue: 210;
    --primary-main: hsl(var(--primary-hue), 90%, 60%);
    --primary-light: hsl(var(--primary-hue), 40%, 15%);
    --primary-dark: hsl(var(--primary-hue), 90%, 70%);
    
    --bg: #0f172a;
    --card: #1e293b;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --border: #334155;
    --warning-text: #fde68a;
  }

  html { font-size: 16px; scroll-behavior: smooth; }
  
  body {
    margin:0;
    padding: 60px 0 0 0; /* Adjusted padding for taller banner */
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
  }
  
  body.no-banner { padding-top: 0; }
  
  .global-warning {
    background: var(--warning);
    color: white;
    padding: 12px 18px;
    font-weight: 500;
    font-size: 0.95rem;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 2000;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 12px;
    text-align: center;
  }
  .global-warning a {
    color: inherit !important;
    text-decoration: underline;
    font-weight: 600;
  }
  body.dark .global-warning { color: #1e293b; }

  header {
    padding: 16px 24px;
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
  }

  .brand { display:flex; align-items:center; gap:12px; }
  .logo {
    width:40px; height:40px; border-radius:var(--radius-md);
    background: var(--primary-gradient);
    display:flex; align-items:center; justify-content:center;
    color:white; font-weight:700; font-size: 1.1rem;
    flex-shrink: 0;
  }
  .title { font-weight:600; font-size:1.1rem; }
  .header-avatar {
    width: 40px; height: 40px; border-radius: var(--radius-md); object-fit: cover;
    flex-shrink: 0; border: 2px solid var(--border);
  }

  nav { display:flex; gap:8px; align-items:center; }
  nav button {
    background:transparent; border:none; padding:8px 14px;
    border-radius:var(--radius-sm); cursor:pointer; color:var(--muted);
    font-weight: 500; font-size: 0.95rem;
    transition: all var(--transition-speed) ease;
  }
  nav button:hover { background: var(--primary-light); color: var(--primary-dark); }
  nav button.active {
    background: var(--primary-main);
    color: white;
    font-weight: 600;
  }
  body.dark nav button.active { color: var(--text); }
  
  .container { max-width:1100px; margin:24px auto; padding:0 24px; }
  .page { display:none; margin-top:16px; animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .card {
    background: var(--card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
    border: 1px solid var(--border);
    transition: all var(--transition-speed) ease;
  }
  .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
  }
  
  h1,h2,h3,h4 { margin:8px 0; color:var(--text); font-weight: 700; }
  h2 { font-size: 1.8rem; }
  h3 { font-size: 1.3rem; }
  p { color:var(--muted); line-height:1.6; margin: 4px 0; }
  
  input,textarea,select,button { font-size:1rem; font-family: 'Inter', sans-serif; }
  input,select,textarea {
    width:100%; box-sizing:border-box; padding:12px 14px;
    border-radius:var(--radius-sm); border:1px solid var(--border);
    background:var(--bg); color:var(--text);
    transition: all var(--transition-speed) ease;
  }
  input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary-main);
      box-shadow: 0 0 0 3px hsl(var(--primary-hue), 85%, 45%, 0.2);
  }

  .btn {
    background: var(--primary-gradient);
    color:white; border:none; padding:12px 20px;
    border-radius:var(--radius-sm); cursor:pointer; font-weight: 600;
    transition: all var(--transition-speed) ease;
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn:hover { transform: translateY(-2px); opacity: 0.95; box-shadow: var(--shadow); }
  .btn.secondary { background: var(--primary-light); color: var(--primary-dark); }
  body.dark .btn.secondary { color: var(--primary-main); }
  .btn[disabled] { opacity: 0.6; cursor: not-allowed; transform: none; }

  .footer { text-align:center; font-size:0.9rem; color:var(--muted); padding:24px; }
  .footer-links { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
  
  .hidden { display:none !important; }
  
  #toast {
    position:fixed; bottom:24px; left:50%; transform:translateX(-50%);
    background: #1e293b; color:white; padding:14px 24px;
    border-radius:var(--radius-md); box-shadow: var(--shadow-lg);
    z-index: 3000; visibility:hidden; opacity:0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform: translateX(-50%) translateY(20px);
  }
  #toast.show { visibility:visible; opacity:1; transform: translateX(-50%) translateY(0); }
  #toast.error { background-color: var(--danger); }
  
  .info-box { background-color: var(--primary-light); border-radius: var(--radius-md); padding: 16px; margin: 24px 0; }

  .question-card { margin-top: 16px; padding:16px; border-radius:var(--radius-md); border:1px solid var(--border); }
  
  .chat-bubble {
    padding: 12px 18px; border-radius: var(--radius-lg);
    margin-bottom: 12px; max-width: 90%; word-wrap: break-word; line-height: 1.6;
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .chat-bubble.user { background: var(--primary-gradient); color: white; border-bottom-right-radius: 4px; margin-left: auto; }
  .chat-bubble.model { background-color: var(--primary-light); color: var(--text); border-bottom-left-radius: 4px; margin-right: auto; }
  body.dark .chat-bubble.model { background-color: #334155; }

  .tag { background: var(--primary-light); color: var(--primary-dark); padding: 4px 10px; border-radius: 99px; font-size: 0.8rem; display: inline-block; margin: 4px 4px 4px 0; font-weight: 500; }
  .favorite-btn {
      background: transparent; border: none; cursor: pointer; font-size: 1.5rem;
      padding: 0; color: var(--muted); opacity: 0.5; transition: all var(--transition-speed) ease;
  }
  .favorite-btn:hover { opacity: 1; transform: scale(1.1); }
  .favorite-btn.favorited { opacity: 1; color: #facc15; }

  .loader-spinner {
      width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.5);
      border-top-color: white; border-radius: 50%;
      animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .row { display:flex; gap:24px; flex-wrap:wrap; }
  .col { flex:1; min-width:300px; }

  @media (max-width: 768px) {
    header { flex-wrap: wrap; gap: 16px; padding: 16px; }
    nav { width: 100%; order: 3; overflow-x: auto; padding-bottom: 5px; }
    .brand { width: 100%; justify-content: space-between; }
    .btn[data-action="share"] { display: none; }
    .row { flex-direction: column; gap: 0; }
    .container { margin: 16px auto; padding: 0 16px; }
    body { padding-top: 80px; } /* Adjust for banner on mobile */
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<div id="globalWarningBanner" class="global-warning">
  <span>
    <strong>Support Ending:</strong> Q Solve has moved to Firebase Hosting! Support for this version ends 22 Oct 2025.
  </span>
  <button class="btn" data-action="transfer-data" style="background: rgba(0,0,0,0.2); padding: 8px 14px; font-size: 0.85rem; font-weight: 600; border-radius: 5px; box-shadow: none;">Migrate Now</button>
</div>

<header>
  <div class="brand">
    <div class="logo">Q</div>
    <div>
      <div class="title">Q Solve</div>
      <div class="muted" id="greetingSmall" style="font-size: 0.85rem;">Welcome</div>
    </div>
  </div>
  <nav id="mainNav">
    <button class="nav-btn" data-action="navigate" data-page="homePage">Home</button>
    <button class="nav-btn" data-action="navigate" data-page="solvePage">Solve</button>
    <button class="nav-btn" data-action="navigate" data-page="historyPage">History</button>
    <button class="nav-btn" data-action="navigate" data-page="settingsPage">Settings</button>
  </nav>
  <img id="headerPfp" alt="avatar" class="header-avatar">
</header>

<div class="container">
  <div id="welcomeScreen" class="page card"></div>
  <div id="homePage" class="page"></div>
  <div id="solvePage" class="page"></div>
  <div id="historyPage" class="page"></div>
  <div id="settingsPage" class="page"></div>
  <div id="releaseNotesPage" class="page"></div>
  <div class="footer">
    <div>Q Solve by Kabir Gagneja. Local data stored on this device.</div>
    <div class="footer-links">
      <a href="https://whatsapp.com/channel/0029VbB4DCr9Gv7Qj7NgCX2t" target="_blank">WhatsApp</a>
      <a href="https://www.youtube.com/@KabirInvents" target="_blank">YouTube</a>
      <a href="https://play.google.com/store/apps/developer?id=Kabir+Gagneja+Invents" target="_blank">Play Store</a>
      <a href="https://kabirgagnejayt-lang.github.io/Qsolve/" target="_blank">Website</a>
    </div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

const DEFAULT_API_KEY = 'AIzaSyBY-NvwyiSIJaxI0AOkIwTNRQvm4LoA7yY';

const App = {
  pages: ['welcomeScreen', 'homePage','solvePage','historyPage','settingsPage', 'releaseNotesPage'],
  dataKey: 'qsolve_data_v7',
  userKey: 'qsolve_user_v7',
  releaseKey: 'qsolve_release_seen_v7',
  history: [],
  settings: { name: 'Student', avatar:'', theme:'default', fontSize:16, apiKey: '', useDefaultKey: true },
};

function saveAll() {
  localStorage.setItem(App.dataKey, JSON.stringify(App.history));
  localStorage.setItem(App.userKey, JSON.stringify(App.settings));
}

function loadAll() {
  const h = localStorage.getItem(App.dataKey);
  const u = localStorage.getItem(App.userKey);
  App.history = h ? JSON.parse(h) : [];
  App.settings = u ? Object.assign(App.settings, JSON.parse(u)) : App.settings;
  applyTheme();
}

function showPage(id) {
  App.pages.forEach(p => {
    const el = document.getElementById(p);
    if(el) el.style.display='none';
  });
  const page = document.getElementById(id);
  if(!page) return;
  
  const template = document.getElementById(id + "Template");
  if (template) {
    page.innerHTML = template.innerHTML;
  }
  page.style.display='block';

  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.querySelector(`.nav-btn[data-page="${id}"]`);
  if (activeBtn) activeBtn.classList.add('active');
  
  const header = document.querySelector('header');
  const banner = document.getElementById('globalWarningBanner');
  const shouldHideChrome = (id === 'welcomeScreen' || id === 'releaseNotesPage');
  
  header.style.display = shouldHideChrome ? 'none' : 'flex';
  if (banner) banner.style.display = shouldHideChrome ? 'none' : 'flex';

  if (shouldHideChrome) {
    document.body.classList.add('no-banner');
  } else {
    document.body.classList.remove('no-banner');
  }

  if (id !== 'welcomeScreen' && id !== 'releaseNotesPage') updateHeaderUI();
  if (id === 'settingsPage') updateSettingsPageUI();
  if (id === 'historyPage') refreshHistoryList();
  if (id === 'homePage') refreshHomePage();
}

function applyTheme() {
  document.documentElement.style.fontSize = App.settings.fontSize + 'px';
  document.body.classList.toggle('dark', App.settings.theme === 'dark');
}

function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'show';
    if (type === 'error') toast.classList.add('error');
    setTimeout(() => toast.className = toast.className.replace('show', ''), 4000);
}

function escapeHtml(s) {
  if(!s) return '';
  const el = document.createElement('div');
  el.innerText = s;
  return el.innerHTML;
}

function formatAIResponse(text) {
    return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```(.*?)```/gs, (match, code) => `<pre><code>${escapeHtml(code.trim())}</code></pre>`)
        .replace(/\n/g, '<br>');
}

async function getAIResponse(prompt, history) {
  const apiKey = App.settings.useDefaultKey ? DEFAULT_API_KEY : App.settings.apiKey;

  if (!apiKey) {
    showToast('API Key is not set. Please add one in Settings.', 'error');
    return "Error: API Key is required.";
  }
  try {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
    const chat = model.startChat({ history });
    const result = await chat.sendMessage(prompt);
    return (await result.response).text();
  } catch (error) {
    console.error("Gemini API Error:", error);
    showToast(`AI Error: ${error.message}. Check console.`, 'error');
    return `AI Error: Could not get a response. Is your key correct?`;
  }
}

async function runOcr(source, button) {
  const container = document.getElementById('detectedQuestions');
  if (!container) return;
  
  const originalContent = button.innerHTML;
  button.innerHTML = `<div class="loader-spinner" style="border-top-color: var(--text);"></div> Recognizing...`;
  button.disabled = true;

  try {
    const { data: { text } } = await Tesseract.recognize(source, 'eng');
    const questionRegex = /(?=\n\s*\d+[.)])/;
    let questions = text.split(questionRegex).map(s => s.trim().replace(/\n/g, ' ')).filter(Boolean);

    if (questions.length <= 1 && text.includes('\n\n')) {
        questions = text.split(/\n\s*\n+/).map(s => s.trim().replace(/\n/g, ' ')).filter(Boolean);
    }
    renderDetectedQuestions(questions, text);
  } catch (err) {
    container.innerHTML = `<p class="muted" style="color:var(--danger)">OCR Error: ${err.message}</p>`;
  } finally {
      button.innerHTML = originalContent;
      button.disabled = false;
  }
}

function updateHeaderUI() {
    document.getElementById('greetingSmall').innerText = App.settings.name ? `Hi, ${App.settings.name}` : 'Welcome';
    const headerPfp = document.getElementById('headerPfp');
    if (App.settings.avatar) {
        headerPfp.src = App.settings.avatar;
        headerPfp.style.display = 'block';
    } else {
        headerPfp.style.display = 'none';
    }
}

function updateSettingsPageUI() {
    document.getElementById('userName').value = App.settings.name || '';
    document.getElementById('avatarPreview').src = App.settings.avatar || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Crect width="100" height="100" fill="%23e2e8f0"/%3E%3C/svg%3E';
    document.getElementById('themeSelect').value = App.settings.theme;
    document.getElementById('fontSizeRange').value = App.settings.fontSize;
    
    document.getElementById('apiKeyInput').value = App.settings.apiKey || '';
    const useCustom = !App.settings.useDefaultKey;
    document.getElementById('settingsUseDefault').checked = !useCustom;
    document.getElementById('settingsUseCustom').checked = useCustom;
    document.getElementById('settingsCustomApiKeyContainer').style.display = useCustom ? 'block' : 'none';
}

function refreshHomePage() {
    const userNameDisplay = document.getElementById('userNameDisplay');
    if(userNameDisplay) userNameDisplay.textContent = App.settings.name || 'Student';

    const recentList = document.getElementById('recentList');
    if (recentList) {
        recentList.innerHTML = '';
        if (App.history.length === 0) {
            recentList.innerHTML = `<p class="muted" style="text-align:center; padding: 20px 0;">Your saved conversations will appear here.</p>`;
            return;
        }
        App.history.slice(0, 3).forEach(item => {
            const title = escapeHtml(item.title.slice(0, 80));
            recentList.innerHTML += `<div class="question-card">${title}...</div>`;
        });
    }
}

function renderDetectedQuestions(questions, fullText) {
    const container = document.getElementById('detectedQuestions');
    container.innerHTML = '<h3>Detected Questions</h3>';
    if (questions.length === 0 && fullText) {
        questions = [fullText.replace(/\n/g, ' ')];
    }
    questions.forEach((qText) => {
        const questionHtml = escapeHtml(qText);
        container.innerHTML += `
        <div class="question-card">
            <p class="question-text">${questionHtml}</p>
            <div class="ai-answer-container" style="display: none;"></div>
            <div style="display:flex; gap: 8px; align-items:center; margin-top:16px; flex-wrap: wrap;">
                <select class="ai-personality-select" style="flex-grow:1; min-width: 150px;">
                    <option value="">Default Answer</option>
                    <option value="\\n\\nPlease explain this simply, like I'm 10 years old.">Explain Simply</option>
                    <option value="\\n\\nPlease summarize the key points in a bulleted list.">Summarize</option>
                    <option value="\\n\\nPlease provide a detailed, step-by-step guide.">Step-by-Step</option>
                </select>
                <button class="btn" data-action="start-conversation" style="flex-grow:1;">Find Answer</button>
            </div>
            <div class="conversation-controls" style="display:none; margin-top:16px;">
                <textarea class="follow-up-input" rows="2" placeholder="Ask a follow-up question..."></textarea>
                <button class="btn" data-action="ask-follow-up" style="margin-top:8px; width: 100%;">Send</button>
            </div>
             <div class="save-controls" style="display:none; margin-top:16px;">
                <input type="text" class="tags-input" placeholder="Add tags, comma separated...">
                <button class="btn small secondary" data-action="save-conversation" style="margin-top:8px; width: 100%;">Save to History</button>
            </div>
        </div>`;
    });
}

function refreshHistoryList() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;
    historyList.innerHTML = '';
    const searchTerm = (document.getElementById('historySearch')?.value || '').toLowerCase();
    const showFavorites = document.getElementById('showFavoritesToggle')?.checked;

    const filteredHistory = App.history.filter(item => {
        if (showFavorites && !item.isFavorited) return false;
        
        const conversationText = item.conversation.map(turn => turn.parts[0].text).join(' ').toLowerCase();
        const tagsText = (item.tags || []).join(' ').toLowerCase();
        
        return conversationText.includes(searchTerm) || tagsText.includes(searchTerm);
    });

    if (filteredHistory.length === 0) {
        historyList.innerHTML = `<p class="muted" style="text-align:center; padding: 20px 0;">No conversations found.</p>`;
        return;
    }
    filteredHistory.forEach(item => {
        const tagsHtml = (item.tags || []).map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('');
        const conversationHtml = item.conversation.map(turn => {
            const bubbleClass = turn.role === 'user' ? 'user' : 'model';
            return `<div class="chat-bubble ${bubbleClass}">${formatAIResponse(turn.parts[0].text)}</div>`;
        }).join('');
        
        historyList.innerHTML += `<div class="card" style="padding: 16px;">
            <div style="display:flex; justify-content:space-between; align-items:start; gap: 12px;">
                <h4 style="margin:0;">${escapeHtml(item.title)}</h4>
                <button class="favorite-btn ${item.isFavorited ? 'favorited' : ''}" data-action="toggle-favorite" data-id="${item.id}">â˜…</button>
            </div>
            <div style="margin-top: 8px;">${tagsHtml}</div>
            <div class="ai-answer-container" style="display:block; margin-top:16px;">${conversationHtml}</div>
            <div style="margin-top:16px; border-top: 1px solid var(--border); padding-top: 16px;">
                <button class="btn small secondary" data-action="copy-conversation" data-id="${item.id}">Copy</button>
            </div>
        </div>`;
    });
    if (window.MathJax) MathJax.typesetPromise && MathJax.typesetPromise();
}

function handleAvatarUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        App.settings.avatar = e.target.result;
        saveAll();
        updateHeaderUI();
        updateSettingsPageUI();
    };
    reader.readAsDataURL(file);
}

function init() {
  loadAll();
  
  document.body.addEventListener('click', async (e) => {
    const target = e.target.closest('[data-action]');
    if (!target) return;
    const action = target.dataset.action;
    const card = target.closest('.card, .question-card');
    
    if (action === 'navigate') showPage(target.dataset.page);
    
    if (action === 'accept-welcome') {
      App.settings.name = document.getElementById('setupName').value.trim() || 'Student';
      const useDefault = document.getElementById('setupUseDefault').checked;
      App.settings.useDefaultKey = useDefault;
      if (!useDefault) {
          App.settings.apiKey = document.getElementById('setupApiKey').value.trim();
      } else {
          App.settings.apiKey = '';
      }
      saveAll();
      localStorage.setItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`, 'true');
      showPage('homePage');
    }

    if (action === 'continue-from-release') {
        localStorage.setItem(App.releaseKey, 'true');
        const isFirstTime = localStorage.getItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`) !== 'true';
        showPage(isFirstTime ? 'welcomeScreen' : 'homePage');
    }

    if (action === 'run-ocr') {
        const file = document.getElementById('ocrFile')?.files[0];
        const text = document.getElementById('pasteText')?.value.trim();
        if (file) runOcr(file, target);
        else if (text) renderDetectedQuestions(text.split(/\n\s*\n+/), text);
        else showToast('Please select a file or paste text.', 'error');
    }
    
    if (action === 'start-conversation' || action === 'ask-follow-up') {
        if (!card) return;
        const answerContainer = card.querySelector('.ai-answer-container');
        const questionTextElem = card.querySelector('.question-text');
        const followUpInput = card.querySelector('.follow-up-input');
        
        let prompt;
        let existingHistory = JSON.parse(card.dataset.conversationHistory || '[]');

        if (action === 'start-conversation') {
            const personalitySelect = card.querySelector('.ai-personality-select');
            prompt = questionTextElem.innerText + (personalitySelect.value || '');
            answerContainer.innerHTML = `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;
        } else {
            prompt = followUpInput.value.trim();
            if (!prompt) return;
            answerContainer.innerHTML += `<div class="chat-bubble user">${formatAIResponse(prompt)}</div>`;
            followUpInput.value = '';
        }
        
        answerContainer.style.display = 'block';
        const originalContent = target.innerHTML;
        target.innerHTML = `<div class="loader-spinner"></div> Thinking...`;
        target.disabled = true;

        const aiResponse = await getAIResponse(prompt, existingHistory);
        
        existingHistory.push({ role: 'user', parts: [{ text: prompt }] });
        existingHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
        card.dataset.conversationHistory = JSON.stringify(existingHistory);

        answerContainer.innerHTML += `<div class="chat-bubble model">${formatAIResponse(aiResponse)}</div>`;
        if (window.MathJax) MathJax.typesetPromise?.([answerContainer]);

        if (action === 'start-conversation') {
            target.parentElement.style.display = 'none';
            card.querySelector('.conversation-controls').style.display = 'block';
            card.querySelector('.save-controls').style.display = 'block';
        }
        target.innerHTML = originalContent;
        target.disabled = false;
    }
    
    if (action === 'save-conversation') {
        if (!card) return;
        const history = JSON.parse(card.dataset.conversationHistory || '[]');
        if (history.length === 0) return;

        const tagsInput = card.querySelector('.tags-input');
        const tags = tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);

        const historyItem = {
            id: 'q-' + Date.now(),
            title: history[0].parts[0].text.slice(0, 100),
            isFavorited: false,
            tags: tags,
            createdAt: new Date().toISOString(),
            conversation: history
        };

        App.history.unshift(historyItem);
        saveAll();
        
        target.textContent = 'Saved âœ“';
        target.disabled = true;
        showToast('Conversation saved to history!');
    }

    if (action === 'toggle-favorite') {
        const itemId = target.dataset.id;
        const item = App.history.find(i => i.id === itemId);
        if (item) {
            item.isFavorited = !item.isFavorited;
            saveAll();
            refreshHistoryList();
        }
    }

    if (action === 'copy-conversation') {
        const itemId = target.dataset.id;
        const item = App.history.find(i => i.id === itemId);
        if (item) {
            const textToCopy = item.conversation.map(turn => `${turn.role.toUpperCase()}: ${turn.parts[0].text}`).join('\n\n');
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Conversation copied!');
            }, () => {
                showToast('Failed to copy.', 'error');
            });
        }
    }
    
    if (action === 'save-settings') {
      App.settings.name = document.getElementById('userName').value.trim();
      const useDefault = document.getElementById('settingsUseDefault').checked;
      App.settings.useDefaultKey = useDefault;
       if (!useDefault) {
          App.settings.apiKey = document.getElementById('apiKeyInput').value.trim();
      } else {
          App.settings.apiKey = '';
      }
      saveAll();
      updateHeaderUI();
      showToast("Settings saved!");
    }
    
    if (action === 'reset-app') {
        if (confirm('This will permanently delete all your data. Are you sure?')) {
            localStorage.clear();
            window.location.reload();
        }
    }

    if (action === 'export-data') {
        const data = { settings: App.settings, history: App.history };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qsolve_backup_${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Data exported!');
    }

    if (action === 'transfer-data') {
        const data = { settings: App.settings, history: App.history };
        const jsonString = JSON.stringify(data);
        const encodedData = encodeURIComponent(jsonString);
        const migrateUrl = `https://qsolve.qzz.io/migrate?Data=${encodedData}`;

        if (migrateUrl.length > 2000) {
            showToast('Error: Data too large for URL migration. Use "Export Data" instead.', 'error');
            return;
        }

        window.location.href = migrateUrl;
    }

  });
  
  document.body.addEventListener('change', e => {
    const target = e.target;
    if (target.id === 'avatarUpload') handleAvatarUpload(e);
    if (target.id === 'importDataInput') {
        const file = target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if (data.settings && data.history) {
                    App.settings = data.settings;
                    App.history = data.history;
                    saveAll();
                    loadAll(); 
                    showPage('settingsPage');
                    showToast('Data imported successfully!');
                } else {
                    showToast('Invalid backup file format.', 'error');
                }
            } catch (err) {
                showToast('Failed to parse backup file.', 'error');
            }
        };
        reader.readAsText(file);
    }
    if (target.id === 'themeSelect') {
        App.settings.theme = target.value;
        applyTheme();
        saveAll();
    }
    
    if (target.name === 'apiKeyChoiceSetup' || target.name === 'apiKeyChoiceSettings') {
        const isSetup = target.name === 'apiKeyChoiceSetup';
        const containerId = isSetup ? 'setupCustomApiKeyContainer' : 'settingsCustomApiKeyContainer';
        const container = document.getElementById(containerId);
        if (container) {
            container.style.display = target.value === 'custom' ? 'block' : 'none';
        }
    }
  });

  document.body.addEventListener('input', e => {
      if (e.target.id === 'fontSizeRange') {
        App.settings.fontSize = e.target.value;
        document.documentElement.style.fontSize = App.settings.fontSize + 'px';
        saveAll();
      }
      if (e.target.id === 'historySearch' || e.target.id === 'showFavoritesToggle') {
        refreshHistoryList();
      }
  });

  const isFirstTime = localStorage.getItem(`qsolve_first_time_${App.dataKey.split('_')[2]}`) !== 'true';
  const releaseSeen = localStorage.getItem(App.releaseKey) === 'true';

  if (isFirstTime && !releaseSeen) {
      showPage('releaseNotesPage');
  } else if (isFirstTime) {
      showPage('welcomeScreen');
  } else {
      showPage('homePage');
  }
}

init();
</script>

<template id="welcomeScreenTemplate">
  <h2>Welcome to Q Solve</h2>
  <p class="muted">Your personal homework helper. To get started, please set your name and choose an API key option.</p>
  <div style="margin-top:24px;">
    <label>Your Name</label>
    <input id="setupName" placeholder="e.g., Alex" />
  </div>
  
  <div class="info-box">
    <p><strong>AI Features require a Gemini API Key.</strong></p>
    <div id="setupApiKeyOptions" style="margin-top:8px;">
        <input type="radio" id="setupUseDefault" name="apiKeyChoiceSetup" value="default" checked>
        <label for="setupUseDefault" class="muted">Use the default shared API key</label>
        <br>
        <input type="radio" id="setupUseCustom" name="apiKeyChoiceSetup" value="custom" style="margin-top:5px;">
        <label for="setupUseCustom" class="muted">Use my own Gemini API key</label>
    </div>
    <div id="setupCustomApiKeyContainer" style="display:none; margin-top:10px;">
        <p class="muted" style="margin-bottom:5px;">Get a free key from <a href="https://aistudio.google.com/" target="_blank" rel="noopener">aistudio.google.com</a>.</p>
        <input type="password" id="setupApiKey" placeholder="Paste your key here">
    </div>
  </div>

  <button class="btn" data-action="accept-welcome" style="margin-top:15px; width:100%;">Start Solving</button>
</template>

<template id="homePageTemplate">
  <div class="card">
    <h2>Hello, <span id="userNameDisplay">Student</span> ðŸ‘‹</h2>
    <p class="muted">Ready to solve some problems? Get started below.</p>
    <div style="display:flex; gap:12px; margin-top:20px;">
      <button class="btn" data-action="navigate" data-page="solvePage">Solve a New Question</button>
      <button class="btn secondary" data-action="navigate" data-page="historyPage">View History</button>
    </div>
  </div>
  <div class="card">
    <h3>Recent Conversations</h3>
    <div id="recentList"></div>
  </div>
  <div class="card">
    <h3>What's New</h3>
    <p>We've updated the app with a new look and new features. See what's changed!</p>
    <button class="btn secondary" data-action="navigate" data-page="releaseNotesPage" style="margin-top:16px;">View Release Notes</button>
  </div>
</template>

<template id="solvePageTemplate">
  <div class="card">
    <h2>Solve a Question</h2>
    <p class="muted">Upload an image of a worksheet or paste text directly to begin.</p>
    <input type="file" id="ocrFile" accept="image/*,application/pdf" style="margin-top:16px;">
    <textarea id="pasteText" rows="5" placeholder="Or paste question text here..." style="margin-top:12px;"></textarea>
    <button class="btn" data-action="run-ocr" style="margin-top:16px; width: 100%;">Extract Questions</button>
    <div id="detectedQuestions" style="margin-top:24px;"></div>
  </div>
</template>

<template id="historyPageTemplate">
  <div class="card">
      <h2>Conversation History</h2>
      <p class="muted">All your saved conversations and their AI-generated answers.</p>
      <input type="search" id="historySearch" placeholder="Search conversations..." style="margin-bottom:16px;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
        <input type="checkbox" id="showFavoritesToggle" style="width: auto; margin:0;">
        <label for="showFavoritesToggle" class="muted">Show Favorites Only</label>
      </div>
      <div id="historyList" style="margin-top:12px;"></div>
  </div>
</template>

<template id="settingsPageTemplate">
  <div class="row">
    <div class="col card">
      <h2>Profile</h2>
      <div style="display:flex; gap:16px; align-items:center;">
        <img src="" alt="avatar" id="avatarPreview" class="avatar-preview" style="width:80px; height:80px; border-radius: 50%;">
        <div style="flex:1;">
          <label>Your Name</label>
          <input type="text" id="userName" placeholder="Your name">
          <label for="avatarUpload" class="btn secondary" style="margin-top:12px; text-align:center; display:block;">Change Avatar</label>
          <input type="file" id="avatarUpload" accept="image/*" class="hidden">
        </div>
      </div>
    </div>
    <div class="col card">
      <h2>AI Settings</h2>
      <div id="settingsApiKeyOptions">
          <input type="radio" id="settingsUseDefault" name="apiKeyChoiceSettings" value="default">
          <label for="settingsUseDefault">Use the default shared API key</label>
          <br>
          <input type="radio" id="settingsUseCustom" name="apiKeyChoiceSettings" value="custom" style="margin-top:5px;">
          <label for="settingsUseCustom">Use my own Gemini API key</label>
      </div>
      <div id="settingsCustomApiKeyContainer" style="display:none; margin-top:10px;">
          <p class="muted" style="margin-bottom:5px;">Get a free key from <a href="https://aistudio.google.com/" target="_blank" rel="noopener">aistudio.google.com</a>.</p>
          <input type="password" id="apiKeyInput" placeholder="Paste your key here">
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col card">
      <h2>Preferences</h2>
      <label>Theme</label>
      <select id="themeSelect">
        <option value="default">Light (Default)</option>
        <option value="dark">Dark</option>
      </select>
      <label style="margin-top:16px; display:block;">Font size</label>
      <input id="fontSizeRange" type="range" min="12" max="20" step="1">
    </div>
    <div class="col card">
      <h2>Data Management</h2>
      <p class="muted">Backup or restore your data, or reset the app completely.</p>
      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:16px;">
        <button class="btn small secondary" data-action="export-data">Export (Safe)</button>
        <button class="btn small" data-action="transfer-data" style="background:var(--success);">Migrate (URL)</button>
        <label for="importDataInput" class="btn small secondary">Import</label>
        <input type="file" id="importDataInput" accept=".json" class="hidden">
        <button class="btn small" data-action="reset-app" style="background:var(--danger);">Reset App</button>
      </div>
    </div>
  </div>
  <div class="card" style="text-align:center;">
      <button class="btn" data-action="save-settings" style="width:100%;">Save All Settings</button>
  </div>
</template>

<template id="releaseNotesPageTemplate">
    <div class="card">
        <h2>A Letter to Our Community</h2>
        <p><strong>Release Date:</strong> September 26, 2025</p>
        <hr style="margin: 16px 0; border-color: var(--border);">
        <blockquote>
            <p>To our incredible Q Solve community,</p>
            <p>This isn't just a product update; it's the culmination of years of dreaming, building, failing, and learning, evolving from a simple experiment into something we believe will <strong>fundamentally change the way you learn.</strong></p>
        </blockquote>
        <h3>Our Journey to Today</h3>
        <p>From a clunky prototype to a public web app, your feedback has been crucial. You showed us the need for a mobile-first experience, which led us to this complete, ground-up rebuild designed to be the ultimate learning companion.</p>
    </div>
    <div class="card">
        <h2>âœ¨ What's New in This Version</h2>
        <h3>ðŸ§  AI-Powered Question Answering</h3>
        <p>At the heart of Q Solve is Google's advanced Gemini model. Ask it to "explain quantum entanglement like I'm ten years old." Itâ€™s the patient, brilliant tutor we always wished we had.</p>

        <h3>ðŸ’¬ Conversational Context</h3>
        <p>Our AI remembers the context of your conversation, allowing for a natural, flowing dialogue. Itâ€™s the difference between shouting questions into a void and collaborating with a partner who is actively listening.</p>
        
        <h3>ðŸ“– Enhanced Conversation History</h3>
        <p>Your conversations are now saved locally. You can search your history, tag important chats, and mark your favorites for quick access.</p>

        <h3>ðŸŽ¨ Full Personalization</h3>
        <p>Set your name and avatar, and choose your theme. We designed a crisp <strong>Light Theme</strong> and a beautiful, eye-saving <strong>Dark Theme</strong> for those late-night study sessions.</p>
    </div>
    <div class="card">
        <h2>ðŸš€ The Future & My Other Projects</h2>
        <p>This is just the starting line. While we build new features, feel free to check out my other work:</p>
        <ul>
            <li><a href="https://whatsapp.com/channel/0029VbB4DCr9Gv7Qj7NgCX2t" target="_blank"><strong>WhatsApp Channel</strong></a> - Get updates and join the community.</li>
            <li><a href="https://www.youtube.com/@KabirInvents" target="_blank"><strong>YouTube (@KabirInvents)</strong></a> - Watch tutorials and project showcases.</li>
            <li><a href="https://play.google.com/store/apps/developer?id=Kabir+Gagneja+Invents" target="_blank"><strong>Google Play Store</strong></a> - Discover all my published apps.</li>
            <li><a href="https://kabirgagnejayt-lang.github.io/Qsolve/" target="_blank"><strong>Q Solve Main Website</strong></a> - The official web portal for this app.</li>
        </ul>
        <p style="margin-top:16px;">With sincere gratitude,</p>
        <p><strong>The Q Solve Team</strong></p>
        
        <button class="btn" data-action="continue-from-release" style="margin-top:24px; width:100%; padding:12px;">Continue to App</button>
    </div>
</template>

</body>
</html>

